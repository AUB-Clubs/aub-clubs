generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --------------------
// Enums
// --------------------

enum ClubRole {
  MEMBER
  BOARD         // Generic for logistics, treasurer, etc. (use customTitle for specifics)
  VICE_PRESIDENT
  PRESIDENT
}

enum ClubType {
  ACADEMIC
  ARTS
  BUSINESS
  CAREER
  CULTURAL
  GAMING
  MEDIA
  SPORTS
  SOCIAL
  TECHNOLOGY
  COMMUNITY_SERVICE
  ENVIRONMENTAL
  HEALTH_WELLNESS
  RELIGIOUS
  BEGINNER_FRIENDLY
  COMPETITIVE
  NETWORKING
}

enum PostType {
  ANNOUNCEMENT
  GENERAL
}

enum PostStatus {
  DRAFT
  PUBLISHED
}

enum PostAudience {
  PUBLIC
  MEMBERS_ONLY
  BOARD_ONLY
}

enum MembershipStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum MembershipAction {
  REQUESTED
  ACCEPTED
  REJECTED
  REVOKED // If an admin kicks an active member
}

// --------------------
// Models
// --------------------

model User {
  id              String               @id // Clerk User ID - populated via Clerk Webhooks
  aubnetId        Int                  @unique @map("aubnet_id")
  email           String               @unique
  firstName       String               @map("first_name")
  lastName        String               @map("last_name")
  dob             DateTime             @map("dob")
  bio             String?
  avatarUrl       String?              @map("avatar_url")
  major           String?
  year            Int?
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  // Relations
  memberships     Membership[]
  posts           Post[]               @relation("AuthoredPosts")
  upvotes         Upvote[]
  performedAudits MembershipAuditLog[] @relation("AuditActor")

  @@map("users")
}

model Club {
  id              String           @id @default(uuid())
  crn             Int              @unique
  title           String
  description     String
  imageUrl        String?          @map("image_url")
  bannerUrl       String?          @map("banner_url")
  
  types           ClubType[]       // Cloud Native PG handles scalar arrays natively

  // Relations
  memberships     Membership[]
  posts           Post[]

  @@map("clubs")
}

model Membership {
  id          String               @id @default(uuid())
  userId      String               @map("user_id")
  clubId      String               @map("club_id")
  role        ClubRole             @default(MEMBER)
  customTitle String?              @map("custom_title") // e.g., "Logistics Coordinator"
  status      MembershipStatus     @default(PENDING)
  joinedAt    DateTime             @default(now()) @map("joined_at")

  // Relations
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  club        Club                 @relation(fields: [clubId], references: [id], onDelete: Cascade)
  auditLogs   MembershipAuditLog[]

  @@unique([userId, clubId])
  @@index([clubId, status]) // Optimized for filtering active vs pending members
  
  @@map("memberships")
}

model MembershipAuditLog {
  id           String           @id @default(uuid())
  membershipId String           @map("membership_id")
  actorId      String           @map("actor_id") // The User ID of whoever clicked the button
  action       MembershipAction
  createdAt    DateTime         @default(now()) @map("created_at")

  // Relations
  membership   Membership       @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  actor        User             @relation("AuditActor", fields: [actorId], references: [id])

  // Fast chronological lookup for a user's request history in a specific club
  @@index([membershipId, createdAt(sort: Desc)]) 
  
  @@map("membership_audit_logs")
}

model Post {
  id         String       @id @default(uuid())
  title      String
  content    String
  type       PostType     @default(GENERAL)
  
  // Sprint 2 Additions
  status     PostStatus   @default(DRAFT)
  audience   PostAudience @default(PUBLIC)
  
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  // Foreign Keys
  authorId   String       @map("author_id")
  clubId     String       @map("club_id")

  // Relations
  author     User         @relation("AuthoredPosts", fields: [authorId], references: [id])
  club       Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)
  postImages PostImage[]
  upvotes    Upvote[]

  // Fast filtering by Club, Status, Audience, and Date
  @@index([clubId, status, audience, createdAt(sort: Desc)]) 
  
  @@map("posts")
}

model PostImage {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  imageUrl  String   @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId]) 
  
  @@map("post_images")
}

model Upvote {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  postId    String   @map("post_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId]) 
  @@index([postId]) 
  
  @@map("upvotes")
}